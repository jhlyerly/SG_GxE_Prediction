library(tidyverse)

source("helper_functions.R")

#dateStr generated by the first two input files, which are time-intensive. All following steps should reference the date on which the first two files were re-run.

dateStr <- commandArgs(trailingOnly=TRUE)[1]

######## Process intermediate phenotype, genotype, and environmental data into design matrices for model construction

#### Read in BLUEs derived from phenotypes

allBLUEs <- read.csv(paste0("Intermediate_Outputs/bySiteNursBLUEs_wHD_", dateStr, ".csv"), row.names = 1)
colnames(allBLUEs)[2] <- "FullSampleName"
allBLUEs <- dplyr::mutate(allBLUEs, Location = stringr::str_replace(Environment, "\\d*$", ""))

#### Read in soil and weather data and bind to BLUEs

sMat <- read.csv(paste0("Intermediate_Outputs/meanSoilData_bySite_", dateStr,".csv"), row.names = "Env")
wMat <- read.csv(paste0("Intermediate_Outputs/wMat_", dateStr, ".csv"), row.names = 1)

allBLUEswWeath <- dplyr::left_join(allBLUEs, data.frame(Location = rownames(sMat), sMat), by = "Location")
allBLUEswWeath <- dplyr::left_join(allBLUEswWeath, data.frame(Environment = rownames(wMat), wMat), by = "Environment")

#### Read in marker data and bind to BLUEs

allM <- as.matrix(read.csv(paste0("Intermediate_Outputs/thinned_SG_M_", dateStr, ".csv"), row.names = 1))
allBLUEswWeathwM <- dplyr::left_join(allBLUEswWeath, data.frame(FullSampleName = rownames(allM), allM), by = "FullSampleName")

#### Remove lines without genotype information

#Choice of SNP is arbitrary. Marker set is inputed so NAs will only occur in case of no matching FullSampleName.
firstSNPName <- colnames(allM)[1]

#In this run (Feb0924), resulted in exclusion of 329/10591 rows.
gBLUEswWeathwM <- allBLUEswWeathwM[!is.na(allBLUEswWeathwM[, firstSNPName]), ]

#### Free up memory by clearing variables
rm(list = c("allBLUEs", "allBLUEswWeath", "allBLUEswWeathwM"))

#### Construct PC matrices and their interaction matrices

#Soil PCs
sPCs <- prcomp(scale(sMat))

#Keep PCs up until we accumulate 98% of variance. 11 in Feb0924 run.
nSPCs <- get_PC_n(sPCs, 0.98)

sPC_ls <- sPCs$x
colnames(sPC_ls) <- paste0("s", colnames(sPC_ls))
gBLUEswWeathPCswM <- dplyr::left_join(gBLUEswWeathwM, data.frame(Location = rownames(sPC_ls), sPC_ls[,1:nSPCs]), by = "Location")

#Weather PCs
wPCs <- prcomp(scale(wMat))

#Keep PCs up until we accumulate 98% of variance. 70 in Feb0924 run.
#Remember while we have tons of variables here, the number of samples for those variables is only ~200...
nWPCs <- get_PC_n(wPCs, 0.98)

wPC_ls <- wPCs$x
colnames(wPC_ls) <- paste0("w", colnames(wPC_ls))
gBLUEswWeathPCswM <- dplyr::left_join(gBLUEswWeathPCswM, data.frame(Environment = rownames(wPC_ls), wPC_ls[,1:nWPCs]), by = "Environment")

write.csv(wPC_ls, paste0("Intermediate_Outputs/wPCs_fromWMat_", dateStr, ".csv"))

#Note that this is for X-Validation, not preduction -- will be predicting lines in total training data, not all breeding lines. 

mPCs <- prcomp(allM)

#In Feb 06 run, 1129 markers from 1445 markers and 10870 markers (use higher LD threshold?)
nMPCs <- get_PC_n(mPCs, 0.98)

mPC_ls <- mPCs$x
colnames(mPC_ls) <- paste0("mPC", c(1:ncol(mPC_ls)))

write.csv(mPC_ls, paste0("Intermediate_Outputs/mPCs_fromM_", dateStr, ".csv"))

gBLUEswWeathPCswMPCs <- dplyr::left_join(gBLUEswWeathPCswM, data.frame(FullSampleName = rownames(mPC_ls), mPC_ls[,1:nMPCs]), by = "FullSampleName")

#### Pre-calculate interaction terms for use by models

GxS_Term <- rep(NA, nrow(gBLUEswWeathPCswMPCs))
GxW_Term <- rep(NA, nrow(gBLUEswWeathPCswMPCs))

sPCNames <- colnames(gBLUEswWeathPCswMPCs)[grepl("sPC", colnames(gBLUEswWeathPCswMPCs))][1:nSPCs]
wPCNames <- colnames(gBLUEswWeathPCswMPCs)[grepl("wPC", colnames(gBLUEswWeathPCswMPCs))][1:nWPCs]
mPCNames <- colnames(gBLUEswWeathPCswMPCs)[grepl("mPC", colnames(gBLUEswWeathPCswMPCs))][1:nMPCs]

#Do soil first - comparatively small so multiply all S and M PCs.
for (curSPC in c(1:nSPCs)) {
  #Multiplies all M PCs by single S PC
  newWeathInts <- gBLUEswWeathPCswMPCs[, mPCNames] * gBLUEswWeathPCswMPCs[, sPCNames[curSPC]]
  colnames(newWeathInts) <- paste0(curSPC, colnames(newWeathInts))
  GxS_Term <- cbind(GxS_Term, newWeathInts)
}

###Select "important" PCs from weather and marker matrices
#For weather, we don'tant it to be square -- needs to be L-shaped. Here we set two parameters for W and M...
#For example, with this method for 40/100 w markers and 60/400 M markers, fit 24,400 instead of 40,000
#I will semi-arbitrarily declare that this is a PC that explains more than 0.2% of variation.

wPCVars <- wPCs$sdev^2 / sum(wPCs$sdev^2)
mPCVars <- mPCs$sdev^2 / sum(mPCs$sdev^2)

maxWInt <- length(wPCVars[wPCVars > .002]) #53 Feb0924
maxMInt <- length(mPCVars[mPCVars > .002]) #92 Feb0924

for (curWPC in c(1:maxWInt)) {
  #Multiplies all G PCs by single W PC
  newWeathInts <- gBLUEswWeathPCswMPCs[, mPCNames] * gBLUEswWeathPCswMPCs[, wPCNames[curWPC]]
  colnames(newWeathInts) <- paste0(curWPC, colnames(newWeathInts))
  GxW_Term <- cbind(GxW_Term, newWeathInts)
}

for (curWPC in c((maxWInt+1):nWPCs)) {
  #I THINK the only difference here is limiting the number of PCs for these larger weather vars 
  newWeathInts <- gBLUEswWeathPCswMPCs[, mPCNames[1:maxMInt]] * gBLUEswWeathPCswMPCs[, wPCNames[curWPC]]
  colnames(newWeathInts) <- paste0(curWPC, colnames(newWeathInts))
  GxW_Term <- cbind(GxW_Term, newWeathInts)
}

GxS_Term <- GxS_Term[, -1]
GxW_Term <- GxW_Term[, -1]


#### Free up memory by clearing old variables
rm(list = c("gBLUEswWeathwM", "gBLUEswWeathPCswM"))

#### Assemble ETA list and write out
#We keep in matrix of weather PCs and marker to feed to later functions

eta <-  list(Geno = list(X = gBLUEswWeathPCswMPCs[, grepl("S\\d[A,B,D]_", colnames(gBLUEswWeathPCswMPCs))], model = "BL"),
             Env = list(X = scale(gBLUEswWeathPCswMPCs[, grepl("mean_", colnames(gBLUEswWeathPCswMPCs))]), model = "BL"),
             GxS = list(X = GxS_Term, model = "BL"),
             GxW = list(X = GxW_Term, model = "BL"))

saveRDS(eta, file = paste0("Intermediate_Outputs/gxe_eta_", dateStr, ".rds"))

#### Write out phenotype data and associated information with same rows as used for ETA 

write.csv(gBLUEswWeathPCswMPCs[, c("Environment", "FullSampleName", "Yield", "HD")], file = paste0("Intermediate_Outputs/BLUEs_forEta_", dateStr, ".csv"))
